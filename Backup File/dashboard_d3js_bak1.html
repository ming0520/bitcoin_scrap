<head>
    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        .candle {
            stroke: black;
        }
        .candle.up {
            fill: green;
        }
        .candle.down {
            fill: red;
        }
        .line {
            stroke: blue;
            fill: none;
        }
    </style>
</head>

<div>
    <h2>Bitcoin Data point over timespan</h2>
    <div id="bitcoin-data-point-time-span" data-url="{% url 'bitcoin_hourly_data' %}"></div>
    <svg id="chart" width="800" height="400"></svg>
</div>

<script>
    function processData(dataset) {
        // Assuming the dataset is in the format of OHLC (Open-High-Low-Close) data
        function processData(dataset) {
            if (!Array.isArray(dataset)) {
                dataset = [dataset];
            }
            return dataset.map(d => ({
                date: new Date(d.timestamp),
                open: +d.open,
                high: +d.high,
                low: +d.low,
                close: +d.close
            }));
        }

    $.ajax({
        url: $("#bitcoin-data-point-time-span").attr("data-url"),
        dataType: 'json',
        success: function(data) {
            const dataset = processData(data);

            const margin = { top: 20, right: 20, bottom: 30, left: 50 },
                width = 800 - margin.left - margin.right,
                height = 400 - margin.top - margin.bottom;

            const svg = d3.select("#chart")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

            const x = d3.scaleTime()
                .domain(d3.extent(dataset, d => d.date))
                .range([0, width]);

            const y = d3.scaleLinear()
                .domain([d3.min(dataset, d => d.low), d3.max(dataset, d => d.high)])
                .range([height, 0]);

            const candles = svg.selectAll("g")
                .data(dataset)
                .enter()
                .append("g")
                .attr("transform", d => `translate(${x(d.date)}, 0)`);

            candles.append("line")
                .attr("class", "line")
                .attr("x1", 0)
                .attr("x2", 0)
                .attr("y1", d => y(d.low))
                .attr("y2", d => y(d.high));

            candles.append("rect")
                .attr("class", d => "candle " + (d.open > d.close ? "down" : "up"))
                .attr("x", -5)
                .attr("width", 10)
                .attr("y", d => y(Math.max(d.open, d.close)))
                .attr("height", d => Math.abs(y(d.open) - y(d.close)));

        }
    });
}) // Add closing parenthesis here
</script>
